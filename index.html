<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Selfie Segmentation with Background Image</title>

  <!-- MediaPipe Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js" crossorigin="anonymous"></script>

  <style>
    body {
      margin: 0;
      background: #000;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #fff;
      overflow: hidden;
    }

    .container {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .input_video {
      position: absolute;
      display: none;
    }

    #output_canvas {
      position: absolute;
      max-width: 100%;
      max-height: 100%;
    }

    /* 画像選択ボタン */
    #controlPanel {
      position: fixed;
      top: 16px;
      left: 16px;
      z-index: 10;
    }

    #bgInput {
      display: none;
    }

    .btn-select-image {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      background: rgba(128, 128, 128, 0.6); /* グレー半透明 */
      color: #ffffff;                       /* 白文字 */
      font-size: 14px;
      cursor: pointer;
      backdrop-filter: blur(4px);
      user-select: none;
    }

    .btn-select-image:active {
      transform: translateY(1px);
      opacity: 0.9;
    }

    .status {
      margin-left: 8px;
      font-size: 12px;
      opacity: 0.85;
    }
  </style>
</head>

<body>
  <!-- 画像選択ボタン -->
  <div id="controlPanel">
    <label for="bgInput" class="btn-select-image">背景画像を選択</label>
    <input type="file" id="bgInput" accept="image/*" />
    <span id="imageStatus" class="status">背景画像：未読み込み</span>
  </div>

  <div class="container">
    <!-- Webカメラの映像を取得 -->
    <video class="input_video"></video>
    <!-- 出力用 Canvas -->
    <canvas id="output_canvas" width="1280" height="720"></canvas>
  </div>

  <script>
    let videoElement;
    let canvasElement;
    let canvasCtx;
    let selfieSegmentation;
    let camera;

    // オーバーレイ用画像
    let overlayImage = null;
    let overlayLoaded = false;

    const imageStatus = document.getElementById('imageStatus');
    const bgInput = document.getElementById('bgInput');

    // 画像ソースを設定して読み込みを行うヘルパー
    function setOverlayFromSrc(src) {
      overlayLoaded = false;
      const img = new Image();
      img.onload = () => {
        overlayImage = img;
        overlayLoaded = true;
        imageStatus.textContent = `背景画像：読み込み完了 (${img.width}x${img.height})`;
      };
      img.onerror = () => {
        overlayImage = null;
        overlayLoaded = false;
        imageStatus.textContent = '背景画像：読み込み失敗';
        console.error('背景画像の読み込みに失敗しました');
      };
      img.src = src;
    }

    // ファイル選択から画像を読み込む
    bgInput.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        setOverlayFromSrc(e.target.result); // data URL で読み込む
      };
      reader.readAsDataURL(file);
    });

    // Selfie Segmentation の結果コールバック
    function onResults(results) {
      canvasCtx.save();
      canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

      // segmentationMask を描画
      canvasCtx.drawImage(
        results.segmentationMask,
        0,
        0,
        canvasElement.width,
        canvasElement.height
      );

      // 人物部分のみ描画する
      canvasCtx.globalCompositeOperation = 'source-in';

      if (overlayLoaded && overlayImage) {
        // 背景として選択した画像を描画
        canvasCtx.drawImage(
          overlayImage,
          0,
          0,
          canvasElement.width,
          canvasElement.height
        );
      } else {
        // 画像がまだない場合は、人物部分に単色を入れておく（赤人型を回避したい場合の処理）
        canvasCtx.fillStyle = '#444';
        canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height);
      }

      // 背景部分に元の映像を描画
      canvasCtx.globalCompositeOperation = 'destination-atop';
      canvasCtx.drawImage(
        results.image,
        0,
        0,
        canvasElement.width,
        canvasElement.height
      );

      canvasCtx.restore();
    }

    window.onload = function () {
      videoElement = document.getElementsByClassName('input_video')[0];
      canvasElement = document.getElementById('output_canvas');
      canvasCtx = canvasElement.getContext('2d');

      // 初期背景画像（任意、使わないならコメントアウトでOK）
      // プロジェクト内に img/sky.png がある場合のみ利用してください
      // setOverlayFromSrc('img/sky.png');

      // Selfie Segmentation の初期化
      selfieSegmentation = new SelfieSegmentation({
        locateFile: (file) => {
          return `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`;
        }
      });

      selfieSegmentation.setOptions({
        modelSelection: 0, // 0: 一般モデル, 1: ランドスケープモデル
      });

      selfieSegmentation.onResults(onResults);

      // カメラの初期化
      camera = new Camera(videoElement, {
        onFrame: async () => {
          await selfieSegmentation.send({ image: videoElement });
        },
        width: 960,
        height: 520,
      });

      camera.start();
    };
  </script>
</body>

</html>
